/**
 * Backbone.Rebar v0.4.0
 * Adding a little bit more reinforcement to an already spectacular framework.
 * https://github.com/mcgaryes/rebar
 */
(function(e,t,n){"use strict";var r=e.Rebar={},i=function(e){var n=this,r=function(){n.apply(this,arguments)};return r.prototype=t.extend(n.prototype,e),r},s=r.Services={request:function(e,r,i){var s=this.parseOptions(r),o=s.id,u=s.error,a=s.success,f=s.data,l=this,c=s.url,h={};h.url=s.url?s.url:s.id?this.getServiceEndpointById(o):undefined,t.isUndefined(f)||(h.data=f),h.success=function(e){t.isEmpty(e)?l.handleError(i):l.handleSuccess(i,a,e)},h.error=function(e){l.handleError(i,u,e)},h.cache=!1,h.dataType="json",h.type=e,n.ajax(h)},parseOptions:function(e){return{id:e.id?e.id:undefined,error:e.error?e.error:function(){},success:e.success?e.success:function(){},data:e.data?e.data:undefined,url:e.url?e.url:undefined}},parseError:function(e){var n={};return t.isUndefined(e)||t.isEmpty(e)||t.isNull(e)?(n.code=204,n.message="No Content"):(n.code=e.status,n.message=e.statusText),n.originalError=e,n},handleSuccess:function(e,t,n){t.call(e,n)},handleError:function(e,t,n){t.call(e,this.parseError(n))},get:function(e,t){this.request("GET",e,t)},post:function(e,t){this.request("POST",e,t)},put:function(e,t){this.request("PUT",e,t)},"delete":function(e,t){this.request("DELETE",e,t)}},o=r.Application=function(e){if(o.instance&&!e._bypassSingleton)return o.instance;e&&e.logLevel?o.logLevel=e.logLevel:o.logLevel=o.LogLevel.None,o.instance=this,this.options=e,this.state=o.States.Initialized};o.LogLevel={None:0,Error:10,Info:20,Verbose:30},o.States={Default:0,Initialized:1,Started:3,Faulted:2},o.prototype=Object.create(e.Events,{_state:{value:o.States.Default,writable:!0},state:{get:function(){return this._state},set:function(e){if(this._state===e)return;this._state=e,this._state===o.States.Initialized&&(this.createModel(),this.createView(),this.createRouter(),this.initialize(this.options)),this.trigger("applicationStateDidChange",this.state)}},services:{value:s,writable:!1},initialize:{value:function(e){},writable:!0},createModel:{value:function(){this.model||(this.model=new e.Model)},writable:!0},createView:{value:function(){this.view||(this.view=new f({el:n("#application")}))},writable:!0},createRouter:{value:function(){this.router||(this.router=new l({landing:this.options.landing?this.options.landing:"",dispatcher:this}),this.router.on("routeDidChange",function(e){this.trigger("routeDidChange",e)},this))},writable:!0},startup:{value:function(){this.options.bootstrap?this.services.get({url:this.options.bootstrap,success:function(t){this.model.set("bootstrap",t),e.history.start({pushState:!1}),this.state=o.States.Started},error:function(e){this.error=e,this.state=o.States.Faulted}},this):(e.history.start({pushState:!1}),this.state=o.States.Started)}}}),o.extend=i;var u=r.PersistenceModel=e.Model.extend({getStoargeId:function(){var e="pm";return this.urlRoot&&(e=e+"_"+this.url().split("/")[0]),e},set:function(n,r,i){console.log(n),n==="url"?this.urlRoot=r:t.isObject(n)&&t.has(n,"url")&&!t.isUndefined(n.url)&&(this.urlRoot=n.url),e.Model.prototype.set.call(this,n,r,i)},sync:function(e,n,r){if(e==="read")this.pullLocalStore(n,r);else if(e==="create")localStorage.setItem(n.getStoargeId(),JSON.stringify(t.omit(n.attributes,["url","urlRoot"])));else if(e==="update")this.pullLocalStore(n,r);else{if(e==="patch")throw"'patch' not implemented yet";if(e==="delete")throw"'delete' not implemented yet"}},pullLocalStore:function(e,t){if(localStorage){var n=localStorage.getItem(e.getStoargeId());if(n!==null){console.log(n);var r=JSON.parse(n);e.set(r),t.success&&t.success(e,r,t),e.trigger("sync",e,r,t)}}else{var i="Error: 'localStorage' is not supported";t.error&&t.error(e,i,t),e.trigger("sync",e,i,t)}}}),a=r.View=e.View.extend({initialize:function(){t.extend(this,t.pick(this.options,["render","destroy","transitionIn","transitionOut"]))},destroy:function(){this._isDestroyed||(this._isDestroyed=!0,this.trigger("viewDidDestroy",this),this.off(),this.$el.off(),this.remove())},render:function(e){},transitionIn:function(e,n){t.isFunction(e)&&e.call(n?n:this)},transitionOut:function(e,n){t.isFunction(e)&&e.call(n?n:this)}}),f=r.CompositeView=e.Rebar.View.extend({initialize:function(){this.subViews=[],t.extend(this,t.pick(this.options,["addSubView","removeSubView","removeAllSubViews","destroy"])),a.prototype.initialize.call(this)},addSubView:function(e){e.on("viewDidDestroy",function(e){this.removeSubView(e)},this),this.subViews.push(e);var t=this;e.render(function(n){var r=n?n:e.el;t.$el.append(r)})},addSubViews:function(e){t.each(e,function(e){this.addSubView(e)},this)},removeSubView:function(e){e.cid||(e=t.where(this.subViews,{cid:e})[0]),this.destroySubView(e),this.subViews=t.reject(this.subViews,function(t){return t.cid===e.cid})},removeAllSubViews:function(){t.each(this.subViews,function(e){this.removeSubView(e)},this)},destroy:function(){this.subViews.length>0&&t.each(this.subViews,function(e){this.destroySubView(e)},this),this.subViews=[],a.prototype.destroy.call(this)},destroySubView:function(e){t.isFunction(e.destroy)?e.destroy(!0):t.isUndefined(e.cid)||a.prototype.destroy.call(e)}}),l=r.DependencyRouter=e.Router.extend({landing:"",routes:{"":"handleNoHash","*splat":"handleAll"},staticRoutes:{},initialize:function(e){t.isUndefined(e)||t.isUndefined(e.landing)||(this.landing=e.landing)},handleNoHash:function(){this.handleAll(this.landing+e.history.location.search)},handleAll:function(n){var r=t.isUndefined(n)?e.history.getFragment():n;for(var i in this.staticRoutes)if(i===r){this.staticRoutes[i]();return}var s=this.parseRoute(r),o=this,u=this.getFileLocation(s);this.trigger("routeDidChange",s),this.pRoute=s},parseRoute:function(e){var t=e.split("/"),n,r,i=t[t.length-1].split("?"),s=i[0].split("#"),o=s[0],u=s[1],a=this.parseRouteData(i[1]);t.length===2&&(r=t[0]),t.length===3&&(n=t[0],r=t[1]);if(t.length>3){var f=t.length-2;n="";for(var l=0;l<f;l++)n+=t[l]+(l<f-1?"/":"");r=t[t.length-2]}return{directory:n,file:r,view:o!==""?o:undefined,data:a,anchor:u}},parseRouteData:function(e){if(t.isUndefined(e))return undefined;var n=e.split("&"),r={};return t.each(n,function(e){var t=e.split("=");r[t[0]]=t[1]}),r},getFileLocation:function(e){return t.isUndefined(e.directory)||e.directory===""?t.isUndefined(e.file)||e.file===""?"":e.file:e.directory+"/"+e.file},setStaticRoute:function(e,t){this.staticRoutes[e]=t},setStaticRoutes:function(e){for(var t in e)this.staticRoutes[t]=e[t]}})}).call(this,Backbone,_,$);