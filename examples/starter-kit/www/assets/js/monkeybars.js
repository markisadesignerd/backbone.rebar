(function(){"use strict";var e=0,t=1,n=2,i=3,r=4,s="parallel",o="sequence",a="simple",u=0,l=10,c=20,h=30,f="task",p=100,d="Override Needed",g="Undefined Task",v="No Attributes",m="Unknown Task Type",y="Invalid Arguments",b="Unhandled 'postMessage'",x=this,w=0,k=["name","tid","data","type","concurrent","worker","displayName","state","logLevel","timeout","dependencies","group","processed","tasks","max","count","interval"],T=x.MonkeyBars={};"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=T);var S=function(e){if(!e)return e.logLevel>=l&&O(v),void 0;var t;if(e.tid)t=e;else{var n=e.type,i=e.tasks;if(i&&(e.tasks=N(i)),n)if(n===a)t=new R(e);else if(n===o)t=new P(e);else{if(n!==s)throw m;t=new B(e)}else t=i?new P(e):new R(e)}return t},N=function(e){var t=[];if(e)for(var n=0;e.length>n;n++)t.push(S(e[n]));return t},_=function(e){var t={};for(var n in e)t[n]={value:e[n],writable:!0};return t},C=function(e){var t=w++,n=e?e+t:f+t;return n},E=function(e,t){var n=e.dependencies;if(n)for(var i=n.length,r=0;i>r;r++){var s=n[r];if(s.tid===t.tid)return!0;if(s===t.name&&"undefined"!==t.name)return!0}return!1},A=function(e){if(e.toSource!==void 0&&e.callee===void 0)return e.toSource();if("number"==typeof e||"boolean"==typeof e||"function"==typeof e)return e;if("string"==typeof e)return"'"+e+"'";if("object"==typeof e){var t;if(e.constructor===Array||e.callee!==void 0){t="[";var n,i=e.length;for(n=0;i-1>n;n++)t+=A(e[n])+",";t+=A(e[n])+"]"}else{t="{";var r;for(r in e)t+=r+":"+A(e[r])+",";t=t.replace(/\,$/,"")+"}"}return t}return"UNKNOWN"},j=function(e){var t,n="var console = { log: function(msg) { postMessage({ type: 'console', message: msg }); } };";void 0!==e.worker?"function"==typeof e.worker?t=new e.worker(e):void 0!==e.worker.constructor&&"function"==typeof e.worker.constructor&&(t=new e.worker.constructor(e)):t=new I(e);var i="var workerTask = "+A(t)+"; workerTask.performTask();",r="onmessage = function(e) {"+n+i+"};";return new Blob([r],{type:"text/javascript"})},L=function(e,t){var n=x.URL||x.webkitURL,i=new Worker(n.createObjectURL(e));return i.onmessage=function(e){"complete"===e.data.type?t.complete(e.data.value):"fault"===e.data.type?t.fault(e.data.value):"cancel"===e.data.type?t.cancel():"console"===e.data.type?O(e.data.message):void 0!==t.worker&&"function"==typeof t.worker.handler?t.worker.handler(e):t.logLevel>l&&O(b+": "+A(e.data))},i.onerror=function(){t.fault("WebWorker error.")},i},D=function(e){if("undefined"==typeof Worker||"undefined"==typeof Blob||e.type!==a)return e.performTask(),void 0;var t=L(j(e),e);t.postMessage()},M=function(e){e.count&&$(e),e.when&&z(e),e.doWhile&&W(e)},H=function(e){var t=this,n=function(){t.apply(this,arguments)},i=_(e);return n.prototype=Object.create(t.prototype,i),n},O=function(e){console&&console.log&&console.log(e)},F={_eventMap:void 0,has:function(e){return void 0===this._eventMap||void 0===this._eventMap[e]?!1:!0},off:function(e,t){if(void 0!==this._eventMap&&void 0!==this._eventMap[e])if(e)if(t)for(var n=0;this._eventMap[e].length>n;n++){var i=this._eventMap[e][n];i.callback===t&&(this._eventMap[e]=this._eventMap[e].splice(n,0))}else for(var r=0;this._eventMap[e].length>r;r++){var s=this._eventMap[e][r];s.configurable===!0&&(this._eventMap[e]=this._eventMap[e].splice(r,0))}else this._eventMap={}},on:function(e,t,n,i){void 0===this._eventMap&&(this._eventMap={}),void 0===this._eventMap[e]&&(this._eventMap[e]=[]),void 0===i&&(i=!0),this._eventMap[e].push({callback:t,context:n,configurable:i})},trigger:function(e){if(void 0!==this._eventMap&&void 0!==this._eventMap[e])for(var t=0;this._eventMap[e].length>t;t++){var n=this._eventMap[e][t];n.callback.call(n.context,{type:e,target:this,isConfigurable:n.configurable})}}},I=T.WorkerTask=function(e){if(!e)throw y;void 0!==e.data&&(this.data=e.data),this.performTask=e.performTask};I.prototype={complete:function(e){this.postMessage("complete",e)},fault:function(e){this.postMessage("fault",e)},cancel:function(){this.postMessage("cancel")},postMessage:function(e,t){var n={};void 0!==e&&"string"==typeof e&&(n.type=e),void 0!==t&&(n.value=t),postMessage(n)}},I.extend=function(e){var t=this,n=function(){t.apply(this,arguments)},i=Object.create(t.prototype);for(var r in e)i[r]=e[r];return n.prototype=i,n};var R=T.Task=function(e){var t=this;t.tid=C();for(var n in e)if(e.hasOwnProperty(n)){for(var i=!0,r=0;k.length>r;r++)if(n===k[r]||"function"==typeof e[n]){i=!1;break}i?(void 0===t.options&&(t.options={}),t.options[n]=e[n]):t.hasOwnProperty(n)||(t[n]=e[n])}M(t,e),t.initialize(t.options)};R.prototype=Object.create(F,{_state:{value:e,writable:!0},concurrent:{value:!1,writable:!0},logLevel:{value:u,writable:!0},timeout:{value:void 0,writable:!0},type:{value:a},worker:{value:void 0,writable:!0},__onStateChange:{value:function(){},writable:!0},cancel:{value:function(){this._state>t||(this._state=n,this.logLevel>=c&&O("Canceled: "+this.displayName),this.timeoutId&&clearTimeout(this.timeoutId),this.trigger("cancel"),this.__onStateChange(this._state),this.onCancel())}},complete:{value:function(e){this._state>t||(this._state=r,this.logLevel>=c&&O("Completed: "+this.displayName),this.timeoutId&&clearTimeout(this.timeoutId),0!==arguments.length&&this.operate(e,this),this.trigger("complete"),this.onComplete(),this.__onStateChange(this._state))},writable:!0},destroy:{value:function(){for(var e in this)this.hasOwnProperty(e)&&delete this[e]}},displayName:{get:function(){return this.name?this.name:this.type+":"+this.tid}},fault:{value:function(e){this._state>=n||(this._state=i,this.logLevel>=c&&O("Faulted: "+this.displayName),this.timeoutId&&clearTimeout(this.timeoutId),this.trigger("fault"),this.__onStateChange(this._state,e),this.onFault(e))}},initialize:{value:function(){},writable:!0},onCancel:{value:function(){},writable:!0},onComplete:{value:function(){},writable:!0},onFault:{value:function(){},writable:!0},onStart:{value:function(){},writable:!0},operate:{value:function(e){this.data=e},writable:!0},performTask:{value:function(){throw"performTask: "+d},writable:!0},reset:{value:function(){this._state=e,this.processed=!1}},start:{value:function(){if(!(this._state>=t)){if(this._state=t,this.logLevel>=c&&O("Started: "+this.displayName),void 0!==this.timeout){var e=this;this.timeoutId=setTimeout(function(){e.fault()},this.timeout)}this.trigger("start"),this.__onStateChange(this._state),this.concurrent?D(this):this.performTask(),this.onStart()}},writable:!0},state:{get:function(){return this._state}}}),R.extend=H;var q=T.TaskGroup=function(e){var t=this;if(e&&e.tasks&&(t.tasks=N(e.tasks)),t.tasks)for(var n=0;t.tasks.length>n;n++){var i=t.tasks[n];this._dependencyMap[i.tid]=[],t.setDependeciesForTask(i)}void 0===this.tasks&&(this.tasks=[]),R.call(t,e)};q.prototype=Object.create(R.prototype,{_dependencyMap:{value:{},writable:!0},_currentIndex:{value:0,writable:!0},_processedIndex:{value:0,writable:!0},addSubTask:{value:function(e){if(!e)throw"addSubTask: "+y;e.tid||(e=S(e)),this.setDependeciesForTask(e),this.tasks.push(e)}},addSubTaskAfterTask:{value:function(e,t){if(!e||!t)throw"addSubTaskAfterTask: "+y;if(e&&this._state!==n){e.tid||(e=S(e)),this.setDependeciesForTask(e);var i=this.tasks.indexOf(t);this.tasks.splice(i+1,0,e)}}},addSubTaskBeforeTask:{value:function(e,t){if(!e||!t)throw"addSubTaskBeforeTask: "+y;if(e&&this._state!==n){e.tid||(e=S(e)),this.setDependeciesForTask(e);var i=this.tasks.indexOf(t);this.tasks.splice(i,0,e)}}},cancel:{value:function(){R.prototype.cancel.call(this);for(var t=0;this.tasks.length>t;t++){var i=this.tasks[t];i._state>e?i.cancel():i._state=n}}},getTaskByName:{value:function(e){for(var t=0;this.tasks.length>t;t++){var n=this.tasks[t];if(n.name===e)return n}}},getTaskByTid:{value:function(e){for(var t=0;this.tasks.length>t;t++){var n=this.tasks[t];if(n.tid===e)return n}}},onSubTaskCancel:{value:function(e){for(var t=0;this.tasks.length>t;t++)E(this.tasks[t],e)&&(this.tasks[t]._state=n)},writable:!0},onSubTaskComplete:{value:function(e){e.group.operate(e.data,e)},writable:!0},onSubTaskFault:{value:function(e,t){this.fault(t)},writable:!0},processSubTask:{value:function(e){return void 0===e?(this.logLevel>=l&&O(g),void 0):e._state===n?(this.onSubTaskCancel(e),!0):(this._processedIndex=this._processedIndex+1,e.group=this,e.processed=!0,e.concurrent&&(e.concurrent=this.concurrent),this.logLevel!==u&&(e.logLevel=this.logLevel),e.__onStateChange=function(e,t){e===r?this.group.onSubTaskComplete(this):e===i?this.group.onSubTaskFault(this,t):e===n&&this.group.onSubTaskCancel(this)},e.start(),!1)}},removeSubTask:{value:function(e){if(e){var t=this.tasks.indexOf(e);this.tasks.splice(t,1)}}},reset:{value:function(){if(this.tasks){this._currentIndex=0,this._processedIndex=0;for(var e=0;this.tasks.length>e;e++)this.tasks[e].reset()}R.prototype.reset.call(this)}},setDependeciesForTask:{value:function(e){if(e.dependencies)for(var t=e.dependencies.length,n=0;t>n;n++){var i=e.dependencies[n];if(void 0===i.tid){var r=this.getTaskByTid(i);void 0===r&&(r=this.getTaskByName(i)),void 0!==r&&(i=e.dependencies[n]=r)}i.tid?this._dependencyMap[e.tid].push(i.tid):this._dependencyMap[e.tid].push(i)}}}}),q.extend=H;var B=T.ParallelTask=function(e){var t=this;q.call(t,e)};B.prototype=Object.create(q.prototype,{type:{value:s},addSubTask:{value:function(e){e&&e._state!==n&&(e.tid||(e=S(e)),this.tasks.push(e),this._state>=t&&this.processSubTask(e))}},canProcessSubTask:{value:function(e){if(!e.dependencies)return!0;for(var n=e.dependencies.length,i=n,r=0,s=[],o=[],a=0;n>a;a++){var u=e.dependencies[a];u._state>t?r++:(o.push(u),s.push(u.displayName))}if(i>r){this.logLevel>=h&&O("Cannot process "+e.displayName+" until its dependencies ["+s.join(",")+"] have run");for(var l=function(t){t.target.off("complete",l),this.processSubTask(e)},c=0;o.length>c;c++){var f=o[c];console.log("add event"),console.log(f),f.on("complete",l,this,!1)}return!1}return!0}},hasNoEnabledSubTasks:{value:function(){if(!this.tasks)return!0;for(var e=0;this.tasks.length>e;e++){var t=this.tasks[e];if(t._state!==n)return!1}return!0}},onSubTaskComplete:{value:function(e){this._currentIndex++,q.prototype.onSubTaskComplete.call(this,e),this._currentIndex===this.tasks.length&&this.complete()},writable:!0},performTask:{value:function(){this.hasNoEnabledSubTasks()?this.complete():this.processSubTasks()},writable:!0},processSubTask:{value:function(e){this.canProcessSubTask(e)&&q.prototype.processSubTask.call(this,e)}},processSubTasks:{value:function(){for(var e=0;this.tasks.length>e;e++){var t=this.tasks[e];void 0===t||t.processed||this.processSubTask(t)}}}}),B.extend=H;var P=T.SequenceTask=function(e){var t=this;q.call(t,e)};P.prototype=Object.create(q.prototype,{type:{value:o},onSubTaskCancel:{value:function(e){q.prototype.onSubTaskCancel.call(this,e),this._state!==n&&this.startNextSubTask()},writable:!0},onSubTaskComplete:{value:function(e){if(this._state!==n){var t=this;setTimeout(function(){q.prototype.onSubTaskComplete.call(this,e),t.startNextSubTask()},0)}},writable:!0},performTask:{value:function(){this.startNextSubTask()},writable:!0},startNextSubTask:{value:function(){if(!(this._state>=n))if(this.tasks&&this._currentIndex<this.tasks.length){var e=this.tasks[this._currentIndex++],t=this.processSubTask(e);t&&(this.logLevel>=c&&O("Skipped: "+e.displayName+" Group: "+this.displayName),this.startNextSubTask())}else this.complete()}}}),P.extend=H;var $=function(e){e.itterationIndex=0,e.complete=function(){this.itterationIndex!==this.count-1?(this.reset(),this.itterationIndex++,this.logLevel>=c&&O("Completed:"+this.displayName+" "+this.itterationIndex+" out of "+this.count+" times"),this.performTask()):R.prototype.complete.call(this)}},W=function(t){t.interval=t.interval?t.interval:p,t.complete=function(){if(this.doWhile()){this._state=e;var t=this;0!==this.interval?setTimeout(function(){t.reset(),t.start()},this.interval):t.start()}else R.prototype.complete.call(this)}},z=function(e){e.interval=e.interval?e.interval:p,e.start=function(){var e=this;setInterval(function(){e.when()&&(R.prototype.start.call(e),clearInterval(this))},this.interval)}};T.TaskStates={Initialized:e,Started:t,Canceled:n,Faulted:i,Completed:r},T.TaskTypes={Parallel:s,Sequence:o,Simple:a},T.LogLevels={None:u,Error:l,Info:c,Verbose:h}}).call(this);